{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - AI Day Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Header -->
<header class="app-header">
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-brain"></i>
        <span>AI Day Planner</span>
      </div>
      <div class="user-info">
        <span class="welcome-text">Welcome, <strong>{{ request.user.first_name|default:request.user.username }}</strong></span>
        <a href="{% url 'logout' %}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>
  </div>
</header>

<div class="container my-4">
  
  <!-- Stats Overview -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="stat-card stat-primary">
        <div class="stat-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <div class="stat-content">
          <h3>{{ total_tasks }}</h3>
          <p>Total Tasks</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card stat-success">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ completed_tasks }}</h3>
          <p>Completed</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card stat-warning">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ pending_tasks }}</h3>
          <p>Pending</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card stat-fire">
        <div class="stat-icon">
          <i class="fas fa-fire"></i>
        </div>
        <div class="stat-content">
          <h3>{{ streak }}</h3>
          <p>Day Streak</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row g-4">
    
    <!-- Task Manager -->
    <div class="col-lg-12">
      <div class="card routine-card">
        <div class="card-header">
          <i class="fas fa-calendar-check"></i>
          <span>Task Manager</span>
          <span class="badge ms-2">{{ completion_rate }}% Complete</span>
        </div>
        <div class="card-body">
          
          <!-- Add Task Form -->
          <div class="routine-form-wrapper">
            <form method="POST" action="{% url 'add_routine' %}" id="routineForm">
              {% csrf_token %}
              
              <div class="row g-3 mb-3">
                <div class="col-md-12">
                  <label class="form-label">
                    <i class="fas fa-tasks"></i> Task Name
                  </label>
                  <div class="input-with-icon">
                    <input 
                      type="text" 
                      id="taskInput" 
                      name="title" 
                      class="form-control" 
                      placeholder="E.g., Call mom at 3pm tomorrow..." 
                      required 
                    />
                    <button 
                      type="button" 
                      class="icon-btn" 
                      onclick="startListening()" 
                      title="Voice Input"
                    >
                      <i class="fas fa-microphone"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="form-label">
                    <i class="fas fa-clock"></i> Time
                  </label>
                  <input type="time" id="timeInput" name="time" class="form-control" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    <i class="fas fa-calendar"></i> Date
                  </label>
                  <input type="date" name="date" class="form-control" value="{{ today }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    <i class="fas fa-flag"></i> Priority
                  </label>
                  <select name="priority" class="form-select">
                    <option value="low">游릭 Low</option>
                    <option value="medium" selected>游리 Medium</option>
                    <option value="high">游댮 High</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">
                    <i class="fas fa-tag"></i> Category
                  </label>
                  <select name="category" class="form-select">
                    <option value="work">游눺 Work</option>
                    <option value="personal">游녻 Personal</option>
                    <option value="health">游눩 Health</option>
                    <option value="study">游닄 Study</option>
                    <option value="shopping">游 Shopping</option>
                    <option value="other">游늶 Other</option>
                  </select>
                </div>
              </div>

              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label class="form-label">
                    <i class="fas fa-repeat"></i> Repeat
                  </label>
                  <select name="repeat_type" class="form-select">
                    <option value="once">Once</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">
                    <i class="fas fa-hourglass-half"></i> Duration (min)
                  </label>
                  <input type="number" name="estimated_duration" class="form-control" value="30" min="5" max="480" />
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-plus"></i> Add Task
                </button>
                <button type="button" class="btn btn-info" onclick="startScheduler()">
                  <i class="fas fa-play"></i> Start
                </button>
                <button type="button" class="btn btn-warning" onclick="stopScheduler()">
                  <i class="fas fa-stop"></i> Stop
                </button>
              </div>
            </form>
          </div>

          <!-- Filters -->
          <div class="filters-section mt-4">
            <div class="row g-2">
              <div class="col-md-3">
                <select id="filterStatus" class="form-select form-select-sm" onchange="applyFilters()">
                  <option value="all">All Status</option>
                  <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filterPriority" class="form-select form-select-sm" onchange="applyFilters()">
                  <option value="all">All Priorities</option>
                  <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                  <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                  <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filterCategory" class="form-select form-select-sm" onchange="applyFilters()">
                  <option value="all">All Categories</option>
                  <option value="work" {% if category_filter == 'work' %}selected{% endif %}>Work</option>
                  <option value="personal" {% if category_filter == 'personal' %}selected{% endif %}>Personal</option>
                  <option value="health" {% if category_filter == 'health' %}selected{% endif %}>Health</option>
                  <option value="study" {% if category_filter == 'study' %}selected{% endif %}>Study</option>
                </select>
              </div>
              <div class="col-md-3">
                <input 
                  type="text" 
                  id="searchInput" 
                  class="form-control form-control-sm" 
                  placeholder="游댌 Search tasks..."
                  value="{{ search_query }}"
                  onkeypress="if(event.key === 'Enter') applyFilters()"
                />
              </div>
            </div>
          </div>

          <!-- Tasks List -->
          <div class="routines-list mt-4">
            <div class="list-header">
              <h5>
                <i class="fas fa-list-check"></i> Today's Tasks
                <span class="badge">{{ routines|length }}</span>
              </h5>
            </div>
            
            {% if routines %}
              <ul class="list-group">
                {% for r in routines %}
                <li class="list-group-item task-item {% if r.is_completed %}completed{% endif %}" data-task-id="{{ r.id }}">
                  <div class="routine-item">
                    <div class="task-checkbox">
                      <input 
                        type="checkbox" 
                        {% if r.is_completed %}checked{% endif %}
                        onchange="toggleComplete({{ r.id }})"
                        class="task-check"
                      />
                    </div>
                    <div class="routine-info">
                      <div class="task-main">
                        <span class="routine-time">
                          <i class="fas fa-clock"></i>
                          {{ r.time|time:"g:i A" }}
                        </span>
                        <span class="routine-title">{{ r.title }}</span>
                      </div>
                      <div class="task-meta">
                        <span class="routine-badge badge-{{ r.priority }}">
                          {% if r.priority == 'high' %}游댮{% elif r.priority == 'medium' %}游리{% else %}游릭{% endif %}
                          {{ r.get_priority_display }}
                        </span>
                        <span class="routine-badge badge-{{ r.category }}">
                          {{ r.get_category_display }}
                        </span>
                        <span class="routine-badge badge-time">
                          <i class="fas fa-hourglass-half"></i> {{ r.estimated_duration }}min
                        </span>
                        {% if r.has_subtasks %}
                        <span class="routine-badge badge-subtasks">
                          <i class="fas fa-list"></i> {{ r.subtasks.count }} subtasks
                        </span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="routine-actions">
                      <button class="btn btn-sm btn-outline-primary" onclick="editTask({{ r.id }})" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <a href="{% url 'delete_routine' r.id %}" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Delete this task?')">
                        <i class="fas fa-trash"></i>
                      </a>
                    </div>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                <p>No tasks yet. Add your first task above or ask the AI assistant!</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Tasks & Productivity -->
  <div class="row g-4 mt-2">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-bell"></i>
          <span>Upcoming Tasks</span>
        </div>
        <div class="card-body">
          {% if upcoming %}
            <ul class="upcoming-list">
              {% for task in upcoming %}
              <li class="upcoming-item">
                <span class="upcoming-time">{{ task.time|time:"g:i A" }}</span>
                <span class="upcoming-title">{{ task.title }}</span>
                <span class="badge badge-{{ task.priority }}">{{ task.get_priority_display }}</span>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">No upcoming tasks for today.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>
          <span>Productivity Overview</span>
        </div>
        <div class="card-body">
          <canvas id="productivityChart" height="150"></canvas>
          <div id="statsContainer" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Chatbot Button -->
<button class="chatbot-fab" onclick="toggleChatbot()" title="AI Assistant">
  <i class="fas fa-robot"></i>
  <span class="chat-badge" id="chatBadge" style="display:none;">1</span>
</button>

<!-- Chatbot Modal -->
<div class="chatbot-modal" id="chatbotModal">
  <div class="chatbot-header">
    <div class="chatbot-avatar">
      <i class="fas fa-robot"></i>
    </div>
    <div class="chatbot-title">
      <h3>AI Assistant</h3>
      <p class="chatbot-status"><span class="status-dot"></span> Online</p>
    </div>
    <div class="chatbot-actions">
      <button class="btn-icon" onclick="clearChat()" title="Clear Chat">
        <i class="fas fa-trash"></i>
      </button>
      <button class="btn-icon" onclick="toggleChatbot()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <div class="chatbot-body" id="chatbotBody">
    <div class="chat-welcome">
      <div class="welcome-icon">
        <i class="fas fa-hand-sparkles"></i>
      </div>
      <h4>Hello! I'm your AI assistant</h4>
      <p>I can help you:</p>
      <ul>
        <li>游닇 Create tasks naturally</li>
        <li>游꿢 Break down complex projects</li>
        <li>游눠 Give productivity tips</li>
        <li>游늵 Analyze your schedule</li>
      </ul>
      <div class="quick-actions">
        <button class="quick-btn" onclick="sendQuickMessage('Create a task')">
          <i class="fas fa-plus"></i> Create Task
        </button>
        <button class="quick-btn" onclick="sendQuickMessage('What should I do next?')">
          <i class="fas fa-lightbulb"></i> Suggestions
        </button>
      </div>
    </div>
  </div>
  
  <div class="chatbot-footer">
    <div class="chatbot-input-wrapper">
      <button class="btn-icon" onclick="startVoiceChatbot()" title="Voice Input">
        <i class="fas fa-microphone"></i>
      </button>
      <input 
        type="text" 
        id="chatbotInput" 
        class="chatbot-input" 
        placeholder="Type a message or ask to create a task..."
        onkeypress="if(event.key === 'Enter') sendChatMessage()"
      />
      <button class="btn-send" onclick="sendChatMessage()" title="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <div class="chatbot-suggestions">
      <span class="suggestion-chip" onclick="sendQuickMessage('Add meeting at 3pm')">Add meeting at 3pm</span>
      <span class="suggestion-chip" onclick="sendQuickMessage('Show my tasks')">Show my tasks</span>
      <span class="suggestion-chip" onclick="sendQuickMessage('Productivity tips')">Productivity tips</span>
    </div>
  </div>
</div>

<!-- Chatbot Overlay -->
<div class="chatbot-overlay" id="chatbotOverlay" onclick="toggleChatbot()"></div>

<script src="{% static 'main.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>